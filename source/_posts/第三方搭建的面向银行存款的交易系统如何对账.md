---
title: 第三方搭建的面向银行存款的交易系统如何对账
date: 2022-09-14 21:26:01
tags: 
    - 交易系统
    - 对账
    - 系统架构
---

## 背景
前段时间沸沸扬扬的河南村镇银行的事件已经接近尾声，
这是一个面向银行存款的交易系统。一个完整的交易过程是这样：用户首先通过我们的系统开户，开户后银行会给用户分配一个电子账户。之后用户往该电子账户上充值。然后选择存款产品，完成购买。银行周期性的给这些存款订单派发收益。用户也可以随时主动发起存款订单的支取，或者等到存款到期，银行把钱打到用户的电子账户上。用户电子账户上的钱可以随时提现。以上就是一个完整的交易过程。因为我们的信息系统和银行的信息系统可能会因为系统缺陷、网络异常等原因造成两边数据不一致，从而影响到用户体验和导流分润等，所以通过对账来检查数据一致性就显得很有必要。

## 对账的目标
因为系统难免会存在缺陷、网络总是不稳定的。如果说补偿是保证数据最终一致性的关键机制，那对账是保证数据一致性的最后一道防线。对于这样一个交易系统，对账的一个基本目标就是完成两个信息系统间交易订单的核对。在对账之前，我们对自己的系统是有一个预期的：我们的系统数据和银行的系统数据大体一致。为什么说“大体”一致呢。因为有些东西天然就是不一致的，比如时间。信息流总是先经过我们，再经过银行，所以如果我们的时间总会比银行的时间早。但是订单状态、金额、产品信息等一定是一致的。
除此之外，还有一个目标就是同步订单收益，更新资产账户（累计收益账户、持有收益账户）。你可能会问：银行已经有账户了，我们为什么不直接查银行的？为什么要做账户？因为我们不止接一家银行，会有 N 家银行，在加上 M 家流量方，我们针对用户资产的统计需求是多维度的。如果要统计一个用户在我们系统的总收益，那么我们需要同时查询多家银行。再者就是银行也不是靠谱的，之前出现过有家银行可以无限提现，始终不扣减电子账户余额。话说回来，数据这个东西是业务的核心资产。有数据才能产生更多价值。

## 对账的流程
对账涉及到的系统包括：
* 定时调度平台（每日定时通过RPC调用对账服务，触发对账）
* 对账服务（对账逻辑）
* 订单服务（查询D-1日交易订单）
* 账户服务（收益入账）
* 银行SFTP对账下载服务（查询D-1日交易对账文件）
  
定时调度平台每日凌晨1点通过 RPC 调用对账服务，触发对账。对账服务收到对账请求后，先将对账任务按银行、交易类型和对账日期的维度拆分，然后落库。之后将对账每个对账任务组装成MQ消息，发送至 RabbitMQ。定时服务同时也作为消息的消费者，订阅该消息。收到消息后，根据消息内容完成指定的对账任务。首先，下载银行D-1的相应交易类型的对账文件，文件存档并解析落库 t1。然后将D-1日从订单服务中查询拿到订单落新的库 t2。之后从 t2 中取一条数据，然后根据订单号去 t1 中取数据，如果没有，则表示系统单边，记录对账状态为单边。如果有，则对比订单金额、产品编码等信息。如果都一致，记录对账状态为对平。如果不一致，记录对账状态为差错。（这里的对账状态在 t1、t2 中都存在）。当 t2 中所有数据遍历完成后，标记 t1 中未对账的数据的对账状态为单边。之后更新对账任务表的对账状态为完成。当消费者消费完 MQ 中所有对账任务的消息后，D-1 日的对账任务宣告完成。
对于以上 t1 和 t2 中对账状态不是对平的记录，我们会在当日逐个排查问题。对于订单金额或者产品编码不一致的，一般是银行问题，需要联系银行处理。对于系统单边的数据，也需要联系银行核实后，我们更新订单状态。（一般这种情况是由于银行交易失败，但是因为网络问题等，我们错误的任务交易成功）。对于银行单边问题，可能是由于我们补偿订单状态失败，或者掉单。补偿失败好说，再人工补偿一下。但是对于掉单的问题，不能忽视，这表明我们系统落库失败但还是将交易请求发给了银行。需要整改。
